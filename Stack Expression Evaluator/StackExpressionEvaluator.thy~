theory StackExpressionEvaluator
  imports Main
begin

datatype expr = Const nat | Add expr expr

datatype instr = Load nat | Write | AddTop


fun run :: "instr list \<Rightarrow> nat list \<Rightarrow> nat list" where
  "run (Load n # is) s = run is (n # s)" |
  "run (Write #  is) (x # xs) = run is xs " | 
  "run (AddTop # is ) (x # y # xs) = run is ((x + y) # xs) " |
  "run (AddTop # is) s = [] " | 
  "run [] s = s "|
  "run s [] = []" 


fun comp :: "expr \<Rightarrow> instr list" where
  "comp (Const n) = [Load n]" |
  "comp (Add e1 e2) = comp e1 @ comp e2 @ [AddTop]"


fun eval :: "expr \<Rightarrow> nat" where
  "eval (Const n)= n " |
  "eval (Add e1 e2) = eval e1 + eval e2" 

 
value "eval (Const 5)"
value "comp (Const 5) "
value "run (comp (Const 5)) []"
value "eval (Add (Const 8) (Const 3))" 
value "comp (Add (Const 10) (Add (Const 1) (Const 2)))" 
value "run (load 5) [] "
value "run write [3,7,8]"
value "Addtop [3,5]"

end