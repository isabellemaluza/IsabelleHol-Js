theory ArvoresPercursos2
  imports Main
begin 

datatype 'a btree = Leaf | Node "'a btree" 'a "'a btree"

fun height :: "'a btree \<Rightarrow> nat" where
  "height Leaf = 0"
| "height (Node l _ r) = Suc (max (height l) (height r))"

fun insert_bst :: "'a::linorder \<Rightarrow> 'a btree \<Rightarrow> 'a btree" where
  "insert_bst x Leaf = Node Leaf x Leaf"
| "insert_bst x (Node l y r) =
     (if x < y then Node (insert_bst x l) y r
      else if x > y then Node l y (insert_bst x r)
      else Node l y r)"

definition from_list :: "'a::linorder list \<Rightarrow> 'a btree" where
  "from_list xs = foldl (\<lambda>t x. insert_bst x t) Leaf xs"

fun preorder :: "'a btree \<Rightarrow> 'a list" where
  "preorder Leaf = []"
| "preorder (Node l x r) = x # (preorder l @ preorder r)"

fun inorder :: "'a btree \<Rightarrow> 'a list" where
  "inorder Leaf = []"
| "inorder (Node l x r) = inorder l @ [x] @ inorder r"

fun postorder :: "'a btree \<Rightarrow> 'a list" where
  "postorder Leaf = []"
| "postorder (Node l x r) = postorder l @ postorder r @ [x]"

fun nodes_at_level :: "nat \<Rightarrow> 'a btree \<Rightarrow> 'a list" where
  "nodes_at_level _ Leaf = []"
| "nodes_at_level 0 (Node _ x _) = [x]"
| "nodes_at_level (Suc n) (Node l _ r) =
     nodes_at_level n l @ nodes_at_level n r"

definition levels :: "'a btree \<Rightarrow> 'a list list" where
  "levels t = map (\<lambda>k. nodes_at_level k t) [0..<height t]"

definition levelorder :: "'a btree \<Rightarrow> 'a list" where
  "levelorder t = concat (levels t)"

(* -------- vers√£o robusta do balanceamento -------- *)
fun mk_balanced :: "'a list \<Rightarrow> 'a btree" where
  "mk_balanced [] = Leaf"
| "mk_balanced xs =
     (let n = length xs div 2;
          l = take n xs;
          x = xs ! n;
          r = drop (Suc n) xs
      in Node (mk_balanced l) x (mk_balanced r))"

definition balance_bst :: "'a::linorder btree \<Rightarrow> 'a btree" where
  "balance_bst t = mk_balanced (inorder t)"

definition build_and_balance :: "'a::linorder list \<Rightarrow> 'a btree" where
  "build_and_balance xs = mk_balanced (remdups (sort xs))"

(* exemplos (use 'value' no Isabelle) *)
value "let t = from_list [7::int,3,9,1,5,8,10,2,6,4] in preorder t"
value "let t = from_list [7::int,3,9,1,5,8,10,2,6,4] in inorder t"
value "let t = from_list [7::int,3,9,1,5,8,10,2,6,4] in postorder t"
value "let t = from_list [7::int,3,9,1,5,8,10,2,6,4] in levels t"
value "let t = from_list [7::int,3,9,1,5,8,10,2,6,4] in levelorder t"

value "let t = from_list [7::int,3,9,1,5,8,10,2,6,4];
           tb = balance_bst t
       in (height t, height tb, levelorder tb)"

value "let tb = build_and_balance [7::int,3,9,1,5,8,10,2,6,4,4,3,7]
       in (inorder tb, height tb)"

value "
  let tb = build_and_balance [7::int,3,9,1,5,8,10,2,6,4,4,3,7]
  in (preorder tb, inorder tb, postorder tb, levelorder tb)"

end
